# 龙头股模式配置说明

## 问题说明

如果你在配置文件中设置了 `top_n: 5`，但回测结果只显示 3 只股票，可能是因为：

### 原因 1：股票池数量不足

**龙头股模式**是从**给定的股票池**中选择评分最高的 `top_n` 只股票。

```yaml
# test.yaml
ts_codes:
  - "300001.SZ"
  - "300002.SZ"
  - "300003.SZ"

mode: leaders
top_n: 5  # ← 但股票池只有 3 只！
```

**结果：** 只能返回 3 只股票（股票池全部）

### 解决方案

**方案 1：扩大股票池**

```yaml
ts_codes:
  - "300001.SZ"
  - "300002.SZ"
  - "300003.SZ"
  - "000001.SZ"
  - "000002.SZ"
  - "600001.SH"
  - "600002.SH"
  - "600003.SH"
  - "600004.SH"
  - "600005.SH"

mode: leaders
top_n: 5  # 从 10 只股票中选择评分最高的 5 只
```

**方案 2：使用板块模式（推荐）**

```yaml
sector_type: industry  # 或 concept
sector_name: 电子      # 整个行业可能有 100+ 只股票

mode: leaders
top_n: 5  # 从整个行业中选择前 5 大龙头股
```

---

## 配置参数说明

### top_n

**类型：** 整数  
**默认值：** 5  
**说明：** 龙头股模式中选择股票的数量

```yaml
# 选择前 3 大龙头股
mode: leaders
top_n: 3

# 选择前 10 大龙头股
mode: leaders
top_n: 10
```

### mode

**类型：** 字符串  
**可选值：** `individual` | `portfolio` | `leaders`

```yaml
# 逐个回测模式
mode: individual

# 等权组合模式
mode: portfolio

# 龙头股模式
mode: leaders
top_n: 5
```

---

## 完整配置示例

### 示例 1：自定义股票池 + 龙头股模式

```yaml
# configs/custom_leaders.yaml
strategy: kdj
strategy_params:
  n: 9

sector_type: custom
ts_codes:
  # 沪市主板（大市值）
  - "600001.SH"
  - "600002.SH"
  - "600003.SH"
  - "600004.SH"
  - "600005.SH"
  # 深市主板
  - "000001.SZ"
  - "000002.SZ"
  - "000003.SZ"
  # 创业板
  - "300001.SZ"
  - "300002.SZ"

start_date: "20250101"
end_date: "20251231"

mode: leaders
top_n: 5  # 从 10 只股票中选择前 5 大龙头

workers: 4
```

**运行：**
```bash
python -m quant_strategy.cli sector-backtest \
    --config configs/custom_leaders.yaml
```

**预期输出：**
```
龙头股评分：[('600001.SH', '150000.00'), ('600002.SH', '120000.00'), ...]
Top 5 龙头股：['600001.SH', '600002.SH', '600003.SH', '600004.SH', '000001.SZ']
```

---

### 示例 2：行业板块 + 龙头股模式

```yaml
# configs/industry_leaders.yaml
strategy: kdj

sector_type: industry
sector_name: 电子  # 整个电子行业

start_date: "20250101"
end_date: "20251231"

mode: leaders
top_n: 10  # 从电子行业选择前 10 大龙头股

workers: 8
```

**运行：**
```bash
python -m quant_strategy.cli sector-backtest \
    --config configs/industry_leaders.yaml
```

**说明：** 电子行业可能有 200+ 只股票，系统会自动选择评分最高的 10 只作为龙头股。

---

## 龙头股评分标准

| 指标 | 权重 | 说明 |
|------|------|------|
| 成交额（期初 5 日） | 40% | 代表市值和流动性 |
| 流动性稳定性 | 20% | 成交量越稳定越好 |
| 低波动率 | 20% | 波动率越低越好 |
| 市值特征 | 20% | 主板股票得分更高 |

**代码开头评分：**
- `600/601/603` 开头（沪市主板）：3 分
- `000/001/002` 开头（深市主板）：2 分
- `300` 开头（创业板）：1 分

---

## 常见问题

### Q1: 为什么设置了 top_n: 5 但只返回 3 只股票？

**A:** 股票池只有 3 只股票，龙头股模式无法从 3 只中选出 5 只。

**解决：** 扩大股票池或使用板块模式。

### Q2: 如何查看龙头股评分？

**A:** 查看日志输出：
```
00:07:55 | INFO | 龙头股评分：[('600001.SH', '150000.00'), ...]
```

### Q3: 龙头股选择会使用未来数据吗？

**A:** 不会！已修复未来函数问题：
- ✅ 使用**期初 5 日**成交额（非整个回测期）
- ✅ 使用**期初 20 日**波动率（非未来数据）
- ✅ 基于股票代码的市值特征（非回测数据）

### Q4: 如何确保龙头股选择的准确性？

**A:** 
1. 使用更大的股票池（至少 10 只以上）
2. 使用板块模式（行业/概念）
3. 接入外部市值数据（更准确）

---

## 总结

| 配置 | 股票池 | top_n | 结果 |
|------|--------|-------|------|
| 自定义 3 只 | 3 只 | 5 | 返回 3 只 ⚠️ |
| 自定义 10 只 | 10 只 | 5 | 返回 5 只 ✅ |
| 行业板块 | 200 只 | 5 | 返回 5 只 ✅ |

**核心原则：** `top_n` 是从**给定股票池**中选择，股票池大小必须 ≥ `top_n`。
